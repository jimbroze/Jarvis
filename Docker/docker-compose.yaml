version: '3'
services:
  homeassistant:
    container_name: homeassistant
    image: "ghcr.io/home-assistant/home-assistant:stable"
    volumes:
      - /mnt/dietpi_userdata/homeassistant:/config
      - /etc/localtime:/etc/localtime:ro
    restart: unless-stopped
    privileged: true
    network_mode: host
    depends_on:
      - db

#docker exec -it homeassistant bash
#wget -q -O - https://install.hacs.xyz | bash -

  db:
    build:
      context: ./database/
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: "${DB_ROOT_PASSWORD}"
      MYSQL_DATABASE: home_assistant
      MARIADB_USER: "${HA_DB_USER}"
      MARIADB_PASSWORD: "${HA_DB_PASSWORD}"
    volumes:
      - "/mnt/dietpi_userdata/homeassistant/db:/var/lib/mysql"
      - "/mnt/dietpi_userdata/homeassistant/backup/db/:/backup"
    ports:
      - "3306:3306"

  nginx:
    build:
      context: ./nginx/
      args:
        DOMAIN: ${DOMAIN}
        SUBDOMAIN: ${SUBDOMAIN}
    environment:
      DOMAIN: ${DOMAIN}
      SUBDOMAIN: ${SUBDOMAIN}
      EMAIL: ${EMAIL}
      TOKEN: ${DUCKTOKEN}
    depends_on:
      - homeassistant
    volumes:
      - "./nginx/config:/etc/nginx/conf.d"
      - "./certbot/data:/etc/letsencrypt"
      # - "./certbot/www:/var/www/certbot"
    network_mode: host
    restart: unless-stopped

  mosquitto:
    build:
      context: ./mosquitto/
      args:
        PASSWORD: ${MOSQUITTO_PASS}
    volumes:
      - ./mosquitto:/mosquitto/
    ports:
      - '1883:1883'
    restart: unless-stopped

  binday:
    build:
      context: ./binday/
    volumes:
        - "/mnt/dietpi_userdata/homeassistant/binday:/data"
    environment:
      PYTHONUNBUFFERED: 1
      LOCATION_CODE: ${LOCATION_CODE}
      CAL_ID: ${CAL_ID}
      
#   node-red:
#     image: nodered/node-red:latest
#     environment:
#       - TZ=Europe/London
#     ports:
#       - "1880:1880"
#     volumes:
#       - ./node-red:/data
#     depends_on:
#       - homeassistant
#     restart: unless-stopped
    
  appdaemon:
    image: acockburn/appdaemon:latest
    environment:
      HA_URL: "http://192.168.0.11:8123"
      TOKEN: ${HA_APPDAEMON_KEY}
      DASH_URL: "http://192.168.0.11:5050"
    ports:
      - "5050:5050"
    volumes:
      - ./appdaemon:/conf
      - "/sys/class/gpio:/sys/class/gpio"
      # https://github.com/Leapo/Rock64-R64.GPIO needs installing
    depends_on:
      - homeassistant
    restart: unless-stopped
      
  duplicati:
    image: ghcr.io/linuxserver/duplicati
    container_name: duplicati
    environment:
      - PUID=0
      - PGID=0
      - TZ=Europe/London
    volumes:
      - /mnt/dietpi_userdata/homeassistant/backup/config:/config
      - /mnt/dietpi_userdata/backup/:/backups
      - /mnt/dietpi_userdata/homeassistant:/source
    ports:
      - 8200:8200
    restart: unless-stopped
